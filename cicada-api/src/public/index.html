<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CicadaCI Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      .card-hover {
        transition: all 0.3s ease;
      }
      .card-hover:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }
      .status-pending {
        @apply bg-yellow-100 text-yellow-800;
      }
      .status-running {
        @apply bg-blue-100 text-blue-800;
      }
      .status-completed {
        @apply bg-green-100 text-green-800;
      }
      .status-failed {
        @apply bg-red-100 text-red-800;
      }
      .status-cancelled {
        @apply bg-gray-100 text-gray-800;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <div id="app">
      <!-- Navigation -->
      <nav class="gradient-bg text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex justify-between h-16">
            <div class="flex items-center">
              <i class="fas fa-bug text-2xl mr-3"></i>
              <h1 class="text-xl font-bold">CicadaCI Dashboard</h1>
            </div>
            <div class="flex items-center space-x-4">
              <span v-if="currentUser" class="text-sm">
                Welcome, {{ currentUser.username }} ({{ currentUser.role }})
              </span>
              <button
                v-if="!isLoggedIn"
                @click="showLoginModal = true"
                class="bg-white text-purple-600 px-4 py-2 rounded-lg hover:bg-gray-100"
              >
                Login
              </button>
              <button
                v-else
                @click="logout"
                class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600"
              >
                Logout
              </button>
            </div>
          </div>
        </div>
      </nav>

      <!-- Main Content -->
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
          <div class="bg-white rounded-lg shadow-md p-6 card-hover">
            <div class="flex items-center">
              <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                <i class="fas fa-play text-xl"></i>
              </div>
              <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">Total Runs</p>
                <p class="text-2xl font-semibold text-gray-900">
                  {{ stats.totalRuns }}
                </p>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-lg shadow-md p-6 card-hover">
            <div class="flex items-center">
              <div class="p-3 rounded-full bg-green-100 text-green-600">
                <i class="fas fa-check text-xl"></i>
              </div>
              <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">Successful</p>
                <p class="text-2xl font-semibold text-gray-900">
                  {{ stats.successful }}
                </p>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-lg shadow-md p-6 card-hover">
            <div class="flex items-center">
              <div class="p-3 rounded-full bg-red-100 text-red-600">
                <i class="fas fa-times text-xl"></i>
              </div>
              <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">Failed</p>
                <p class="text-2xl font-semibold text-gray-900">
                  {{ stats.failed }}
                </p>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-lg shadow-md p-6 card-hover">
            <div class="flex items-center">
              <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                <i class="fas fa-clock text-xl"></i>
              </div>
              <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">Running</p>
                <p class="text-2xl font-semibold text-gray-900">
                  {{ stats.running }}
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Pipeline Runs Table -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
          <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex justify-between items-center">
              <h2 class="text-lg font-semibold text-gray-900">
                Recent Pipeline Runs
              </h2>
              <button
                @click="refreshRuns"
                class="text-blue-600 hover:text-blue-800"
              >
                <i class="fas fa-sync-alt mr-2"></i>Refresh
              </button>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Pipeline
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Status
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Started
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Duration
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Actions
                  </th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <tr
                  v-for="run in pipelineRuns"
                  :key="run.id"
                  class="hover:bg-gray-50"
                >
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">
                      {{ run.pipelineName }}
                    </div>
                    <div class="text-sm text-gray-500">
                      ID: {{ run.id.substring(0, 8) }}
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span
                      :class="getStatusClass(run.status)"
                      class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                    >
                      {{ run.status }}
                    </span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    {{ formatDate(run.startTime) }}
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    {{ getDuration(run.startTime, run.endTime) }}
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button
                      @click="viewRunDetails(run)"
                      class="text-blue-600 hover:text-blue-900 mr-3"
                    >
                      <i class="fas fa-eye"></i>
                    </button>
                    <button
                      v-if="run.status === 'running'"
                      @click="cancelRun(run.id)"
                      class="text-red-600 hover:text-red-900"
                    >
                      <i class="fas fa-stop"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Login Modal -->
      <div
        v-if="showLoginModal"
        class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"
      >
        <div
          class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"
        >
          <div class="mt-3 text-center">
            <h3 class="text-lg font-medium text-gray-900 mb-4">
              Login to CicadaCI
            </h3>
            <form @submit.prevent="login">
              <div class="mb-4">
                <input
                  v-model="loginForm.username"
                  type="text"
                  placeholder="Username"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  required
                />
              </div>
              <div class="mb-4">
                <input
                  v-model="loginForm.password"
                  type="password"
                  placeholder="Password"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  required
                />
              </div>
              <div class="flex justify-end space-x-3">
                <button
                  type="button"
                  @click="showLoginModal = false"
                  class="px-4 py-2 text-gray-600 hover:text-gray-800"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
                >
                  Login
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Run Details Modal -->
      <div
        v-if="selectedRun"
        class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"
      >
        <div
          class="relative top-10 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white"
        >
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-medium text-gray-900">
              Pipeline Run Details
            </h3>
            <button
              @click="selectedRun = null"
              class="text-gray-400 hover:text-gray-600"
            >
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700"
                  >Pipeline</label
                >
                <p class="mt-1 text-sm text-gray-900">
                  {{ selectedRun.pipelineName }}
                </p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700"
                  >Status</label
                >
                <span
                  :class="getStatusClass(selectedRun.status)"
                  class="mt-1 px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                >
                  {{ selectedRun.status }}
                </span>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Steps</label
              >
              <div class="space-y-2">
                <div
                  v-for="step in selectedRun.steps"
                  :key="step.name"
                  class="border rounded-lg p-3"
                >
                  <div class="flex justify-between items-center mb-2">
                    <span class="font-medium">{{ step.name }}</span>
                    <span
                      :class="getStatusClass(step.status)"
                      class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                    >
                      {{ step.status }}
                    </span>
                  </div>
                  <div
                    v-if="step.output"
                    class="text-sm text-gray-600 bg-gray-50 p-2 rounded"
                  >
                    <pre class="whitespace-pre-wrap">{{ step.output }}</pre>
                  </div>
                  <div
                    v-if="step.error"
                    class="text-sm text-red-600 bg-red-50 p-2 rounded mt-2"
                  >
                    <pre class="whitespace-pre-wrap">{{ step.error }}</pre>
                  </div>
                </div>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Logs</label
              >
              <div
                class="bg-gray-900 text-green-400 p-4 rounded-lg max-h-64 overflow-y-auto"
              >
                <div
                  v-for="log in selectedRun.logs"
                  :key="log.timestamp"
                  class="text-sm"
                >
                  <span class="text-gray-500"
                    >[{{ formatDate(log.timestamp) }}]</span
                  >
                  <span :class="getLogLevelClass(log.level)" class="ml-2"
                    >{{ log.level.toUpperCase() }}:</span
                  >
                  <span class="ml-2">{{ log.message }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const { createApp } = Vue;

      createApp({
        data() {
          return {
            isLoggedIn: false,
            currentUser: null,
            showLoginModal: false,
            selectedRun: null,
            pipelineRuns: [],
            loginForm: {
              username: "",
              password: "",
            },
            stats: {
              totalRuns: 0,
              successful: 0,
              failed: 0,
              running: 0,
            },
          };
        },
        mounted() {
          this.checkAuth();
          this.loadRuns();
          this.startPolling();
        },
        methods: {
          async checkAuth() {
            const token = localStorage.getItem("cicadaci_token");
            if (token) {
              try {
                const response = await axios.get("/api/auth/me", {
                  headers: { Authorization: `Bearer ${token}` },
                });
                this.currentUser = response.data.user;
                this.isLoggedIn = true;
              } catch (error) {
                localStorage.removeItem("cicadaci_token");
              }
            }
          },
          async login() {
            try {
              const response = await axios.post(
                "/api/auth/login",
                this.loginForm
              );
              localStorage.setItem("cicadaci_token", response.data.token);
              this.currentUser = response.data.user;
              this.isLoggedIn = true;
              this.showLoginModal = false;
              this.loginForm = { username: "", password: "" };
            } catch (error) {
              alert(
                "Login failed: " + error.response?.data?.message ||
                  "Unknown error"
              );
            }
          },
          logout() {
            localStorage.removeItem("cicadaci_token");
            this.isLoggedIn = false;
            this.currentUser = null;
          },
          async loadRuns() {
            try {
              const response = await axios.get("/api/runs");
              this.pipelineRuns = response.data.runs;
              this.updateStats();
            } catch (error) {
              console.error("Failed to load runs:", error);
            }
          },
          updateStats() {
            this.stats.totalRuns = this.pipelineRuns.length;
            this.stats.successful = this.pipelineRuns.filter(
              (r) => r.status === "completed"
            ).length;
            this.stats.failed = this.pipelineRuns.filter(
              (r) => r.status === "failed"
            ).length;
            this.stats.running = this.pipelineRuns.filter(
              (r) => r.status === "running"
            ).length;
          },
          async refreshRuns() {
            await this.loadRuns();
          },
          async cancelRun(runId) {
            try {
              await axios.post(`/api/runs/${runId}/cancel`);
              await this.loadRuns();
            } catch (error) {
              alert(
                "Failed to cancel run: " + error.response?.data?.message ||
                  "Unknown error"
              );
            }
          },
          viewRunDetails(run) {
            this.selectedRun = run;
          },
          getStatusClass(status) {
            return `status-${status}`;
          },
          getLogLevelClass(level) {
            const classes = {
              info: "text-blue-400",
              warn: "text-yellow-400",
              error: "text-red-400",
              debug: "text-gray-400",
            };
            return classes[level] || "text-gray-400";
          },
          formatDate(dateString) {
            return new Date(dateString).toLocaleString();
          },
          getDuration(startTime, endTime) {
            const start = new Date(startTime);
            const end = endTime ? new Date(endTime) : new Date();
            const diff = end - start;
            const minutes = Math.floor(diff / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            return `${minutes}m ${seconds}s`;
          },
          startPolling() {
            setInterval(() => {
              if (this.isLoggedIn) {
                this.loadRuns();
              }
            }, 5000); // Poll every 5 seconds
          },
        },
      }).mount("#app");
    </script>
  </body>
</html>
